import { ComponentType } from "discord.js";
import { CustomError } from "../../core/error";
import { markdownToHTML } from "../../core/markdown";
import { ATTACHMENT_CSS, DEFAULT_CSS, EMBED_CSS, MESSAGE_CSS } from "./css";
const COUNT_UNIT = ["KB", "MB", "GB", "TB"];
export class Html {
    guild;
    channel;
    messages;
    options;
    dateFormat;
    constructor(data, options) {
        this.guild = data.guild;
        this.channel = data.channel;
        this.messages = data.messages;
        this.options = options;
        try {
            this.dateFormat = new Intl.DateTimeFormat(options.localDate, {
                timeZone: options.timeZone,
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        catch (error) {
            throw new CustomError("[discord-message-transcript] Invalid LocalDate and/or TimeZone.");
        }
    }
    headerBuilder() {
        return `
        <div style="display: flex;  gap: 1.5rem; align-items: center;">
            ${this.channel.img ? `<img src="${this.channel.img}" style="width: 7rem; height: 7rem; border-radius: 50%;">` : ""}
            <div style="display: flex; flex-direction: column; justify-content: center; gap: 1.25rem;">
                ${this.guild ? `<div id="guild" class="line">
                    <h4>Guild: </h4>
                    <h4 style="font-weight: normal;">${this.guild.name}</h4>
                </div>` : ""}
                ${this.channel.parent ? `<div id="category" class="line">
                    <h4>Category: </h4>
                    <h4 style="font-weight: normal;">${this.channel.parent.name}</h4>
                </div>` : ""}
                <div id="channel" class="line">
                    <h4>Channel: </h4>
                    <h4 style="font-weight: normal;">${this.channel.name}</h4>
                </div>
                ${this.channel.topic ? `<div id="topic" class="line">
                    <h4>Topic: </h4>
                    <h4 style="font-weight: normal;">${this.channel.topic}</h4>
                </div>` : ""}
            </div>
        </div>
        `;
    }
    messagesBuilder() {
        return this.messages.map(message => {
            const date = new Date(message.createdTimesptamp);
            message.content = markdownToHTML(message.content, message.mentions, this.dateFormat);
            message.attachments;
            return `
<div class="messageDiv">
    <img src="${message.author.avatarURL}" class="messageImg">
    <div class="messageDivRight">
        <div class="messageUser">
            <h3 class="messageUsername">${message.member?.displayName ?? message.author.displayName}</h3>
            ${message.author.bot ? `<p class="badge">APP</p>` : ""}
            ${message.author.system ? `<p class="badge">SYSTEM</p>` : ""}
            ${message.author.guildTag ? `<p class="badgeTag">${message.author.guildTag}</p>` : ""}
            <p class="messageTimeStamp">${this.dateFormat.format(date)}</p>
        </div>
        <div class="messageContent">${message.content}</div>
        ${message.embeds.length > 0 ? this.embedBuilder(message, message.embeds) : ""}
        ${message.attachments.length > 0 ? this.attachmentBuilder(message.attachments) : ""}
    </div>
</div>
        `;
        }).join("");
    }
    toHTML() {
        return `
<!DOCTYPE html>
<html lang="pt-BR"></html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>${this.options.fileName}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/atom-one-dark.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/highlight.min.js"></script>
    <style>
    ${DEFAULT_CSS}
    ${MESSAGE_CSS}
    ${EMBED_CSS}
    ${ATTACHMENT_CSS}
    </style>
</head>
<body>
    <header>
        ${this.headerBuilder()}
    </header>
    <main style="display: flex; flex-direction: column; gap: 1.75rem; padding: 2.25rem;">
       ${this.messagesBuilder()}
    </main>
    <footer>
        <br>
        <h2>Transcript generated by <a href="https://github.com/HenriqueMairesse/discord-channel-transcript">discord-channel-transcript</a></h2>
    </foorter>
    <script>
        document.addEventListener('click', function (event) {
            const spoiler = event.target.closest('.spoilerMsg, .spoilerAttachment');
            if (!spoiler) return;
            if (!spoiler.classList.contains('revealed')) {
                event.preventDefault();
                event.stopPropagation();
                spoiler.classList.add('revealed');
            }
        });
        document.addEventListener('DOMContentLoaded', function (event) {
            hljs.highlightAll();
        });
    </script>
</body>
</html>     
`;
    }
    embedBuilder(message, embeds) {
        return embeds.map(embed => {
            const embedAuthor = embed.author ? (embed.author.url ? `<a class="embedHeaderRightAuthorName" href="${embed.author.url}" target="_blank">${embed.author.name}</a>` : `<p class="embedHeaderRightAuthorName">${embed.author.name}</p>`) : "";
            const embedTitle = embed.title ? (embed.url ? `<a class="embedHeaderRightTitle" href="${embed.url}" target="_blank">${embed.title}</a>` : `<p class="embedHeaderRightTitle">${embed.title}</p>`) : "";
            return `
                <div class="embed" style="${embed.hexColor ? `border-left-color: ${embed.hexColor}` : ''}">
                    ${embed.author || embed.title || embed.thumbnail ? `
                    <div class="embedHeader">
                        <div class="embedHeaderRight">
                            ${embed.author ? `
                            <div class="embedHeaderRightAuthor">
                                ${embed.author.iconURL ? `<img class="embedHeaderRightAuthorImg" src="${embed.author.iconURL}">` : ""}
                                ${embedAuthor}
                            </div>` : ""}
                            ${embedTitle}
                        </div>
                        ${embed.thumbnail ? `<img class="embedHeaderThumbnail" src="${embed.thumbnail.url}">` : ""}
                    </div>` : ""}
                    ${embed.description ? `<div class="embedDescription">${markdownToHTML(embed.description, message.mentions, this.dateFormat)}</div>` : ""}
                    ${embed.fields && embed.fields.length > 0 ? `
                    <div class="embedFields">
                        ${embed.fields.map(field => `
                        <div class="embedFieldsField" style="${field.inline ? 'display: inline-block;' : ''}">
                            <p class="embedFieldsFieldTitle">${field.name}</p>
                            <p class="embedFieldsFieldValue">${markdownToHTML(field.value, message.mentions, this.dateFormat)}</p>
                        </div>`).join("")}
                    </div>` : ""}
                    ${embed.image ? `
                    <div class="embedImage">
                        <img src="${embed.image.url}">
                    </div>` : ""}
                    ${embed.footer || embed.timestamp ? `
                    <div class="embedFooter">
                        ${embed.footer?.iconURL ? `<img class="embedFooterImg" src="${embed.footer.iconURL}">` : ""}
                        ${embed.footer?.text || embed.timestamp ? `<p class="embedFooterText">${embed.footer?.text ?? ''}${embed.footer?.text && embed.timestamp ? ' | ' : ''}${embed.timestamp ? this.dateFormat.format(new Date(embed.timestamp)) : ''}</p>` : ""}
                    </div>` : ""}
                </div>
            `;
        }).join("");
    }
    attachmentBuilder(attachments) {
        return attachments.map(attachment => {
            let html = "";
            if (attachment.contentType?.startsWith('image/')) {
                html = `<img class="attachmentImage" src="${attachment.url}">`;
            }
            else if (attachment.contentType?.startsWith('video/')) {
                html = `<video class="attachmentVideo" controls src="${attachment.url}"></video>`;
            }
            else if (attachment.contentType?.startsWith('audio/')) {
                html = `<audio class="attachmentAudio" controls src="${attachment.url}"></audio>`;
            }
            else {
                let fileSize = attachment.size / 1024;
                let count = 0;
                while (fileSize > 512 && count < COUNT_UNIT.length - 1) {
                    fileSize = fileSize / 1024;
                    count++;
                }
                html = `
                    <div class="attachmentFile">
                        <div class="attachmentFileInfo">
                            <p class="attachmentFileName" href="${attachment.url}" target="_blank">${attachment.name ?? 'attachment'}</p>
                            <div class="attachmentFileSize">${fileSize.toFixed(2)} ${COUNT_UNIT[count]}</div>
                        </div>
                        <a class="attachmentDownload" href="${attachment.url}" target="_blank">
                            <svg class="attachmentDownloadIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="m720-120 160-160-56-56-64 64v-167h-80v167l-64-64-56 56 160 160ZM560 0v-80h320V0H560ZM240-160q-33 0-56.5-23.5T160-240v-560q0-33 23.5-56.5T240-880h280l240 240v121h-80v-81H480v-200H240v560h240v80H240Zm0-80v-560 560Z"/></svg>
                        </a>
                    </div>
                `;
            }
            return this.spoilerAttachmentBuilder(attachment.spoiler, html);
        }).join("");
    }
    componentBuilder(message, components) {
        return components.map(component => {
            switch (component.type) {
                case ComponentType.ActionRow: {
                    break;
                }
                case ComponentType.Container: {
                    const html = `
                    <div class="container" style="${component.hexAccentColor ? `border-left-color: ${component.hexAccentColor}` : ''}">
                        ${this.componentBuilder(message, component.components)}
                    </div>
                    `;
                    return this.spoilerAttachmentBuilder(component.spoiler, html);
                }
                case ComponentType.File: {
                    let fileSize = (component.data.size ?? 0) / 1024;
                    let count = 0;
                    while (fileSize > 512 && count < COUNT_UNIT.length - 1) {
                        fileSize = fileSize / 1024;
                        count++;
                    }
                    const html = `
                        <div class="attachmentFile">
                            <div class="attachmentFileInfo">
                                <p class="attachmentFileName">${component.data.name ?? 'file'}</p>
                                <div class="attachmentFileSize">${fileSize.toFixed(2)} ${COUNT_UNIT[count]}</div>
                            </div>
                            <a class="attachmentDownload" href="${component.file.url ?? ''}" target="_blank">
                                <svg class="attachmentDownloadIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="m720-120 160-160-56-56-64 64v-167h-80v167l-64-64-56 56 160 160ZM560 0v-80h320V0H560ZM240-160q-33 0-56.5-23.5T160-240v-560q0-33 23.5-56.5T240-880h280l240 240v121h-80v-81H480v-200H240v560h240v80H240Zm0-80v-560 560Z"/></svg>
                            </a>
                        </div>
                    `;
                    return this.spoilerAttachmentBuilder(component.spoiler, html);
                }
                case ComponentType.MediaGallery: {
                    return `
                    <div class="mediaGallery"> 
                        ${component.items.map(image => {
                        return `
                            <div class="mediaGalleryItem"> 
                                ${this.spoilerAttachmentBuilder(image.spoiler, `<img class="mediaGalleryImg" src="${image.data.media.url}">`)}
                            </div>
                            `;
                    }).join("")}
                    </div>
                    `;
                }
                case ComponentType.Section: {
                    return `
                    <div class="section">
                        <div class="sectionLeft">
                            ${this.componentBuilder(message, component.components)}
                        </div>
                        <div class="sectionRight">
                            ${component.accessory.type == ComponentType.Button ? this.buttonBuilder(component.accessory)
                        : component.accessory.type == ComponentType.Thumbnail ? this.spoilerAttachmentBuilder(component.accessory.spoiler, `
                            <img class="sectionThumbnail" src="${component.accessory.media.url}">
                            `) : ""}
                        </div>
                    </div> 
                    `;
                }
                case ComponentType.Separator: {
                    return `<hr>`;
                }
                case ComponentType.TextDisplay: {
                    return markdownToHTML(component.content, message.mentions, this.dateFormat);
                }
                default:
                    return ``;
            }
        }).join("");
    }
    buttonBuilder(button) {
    }
    spoilerAttachmentBuilder(spoiler, html) {
        return spoiler ? `<div class="spoilerAttachment"><div class="spoilerAttachmentOverlay">SPOILER</div><div class="spoilerAttachmentContent">${html}</div></div>` : html;
    }
}
